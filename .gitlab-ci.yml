---
include:
  - "https://gitlab.dune-project.org/core/ci-config/raw/master/config/common/master.yml"
  - "https://gitlab.dune-project.org/core/ci-config/raw/master/jobs/common/master.yml"

before_script:
  - . /duneci/bin/duneci-init-job
  - duneci-install-module https://gitlab.dune-project.org/core/dune-common.git
  - duneci-install-module https://gitlab.dune-project.org/core/dune-geometry.git

stages:
  - test-dune-uggrid
  - test-downstream

.common: &common
  stage: test-dune-uggrid
  script:
    - duneci-standard-test
    # test dune-grid as well
    - export DUNE_CONTROL_PATH=$(pwd):/duneci/modules:$DUNE_CONTROL_PATH
    - duneci-install-module https://gitlab.dune-project.org/core/dune-grid.git
    - cd /duneci/modules/dune-grid && duneci-standard-test
  tags: [duneci]
  artifacts:
    expire_in: 2 years
    reports:
      junit: junit/*.xml

.common-downstream: &common-downstream
  stage: test-downstream
  script:
    # test dune-grid
    - export DUNE_CONTROL_PATH=$(pwd):/duneci/modules:$DUNE_CONTROL_PATH
    - duneci-install-module https://gitlab.dune-project.org/core/dune-grid.git
    - cd /duneci/modules/dune-grid && duneci-standard-test
  tags: [duneci]
  artifacts:
    expire_in: 2 years
    reports:
      junit: junit/*.xml

downstream debian:11 gcc-9-20:
  <<: *common-downstream
  image: registry.dune-project.org/docker/ci/debian:11
  variables:
    DUNECI_TOOLCHAIN: gcc-9-20
